---
title: "GeoPAT 2"
subtitle: "analysis of spatial and temporal patterns"
author: "Jakub Nowosad"
date: "2018-08-22 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
          css: ["my_theme.css", "default"]
          lib_dir: libs
          nature:
                  highlightStyle: github
                  highlightLines: true
                  countIncrementalSlides: false
                  ratio: 16:9
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
# knitr::opts_chunk$set(eval = FALSE)
```

layout: false
class: middle, center

# Introduction

---
layout: false
class: middle, center

# Core ideas

---
### Motifel

- Most of the spatial raster analyses use single pixels as its main unit of analysis. <!--Each pixel has one value (e.g. land cover class) and relatively small size (e.g. 90 meters).--> The value of a single pixel can show a local property, however, it says nothing about a local spatial pattern.

- <!--Therefore, the question is how a local pattern can be depicted?--> In our approach, we consider a square block of pixels as a representation of a local pattern (“motif”). This block of pixels is called a motifel and it is an elementary unit of the pattern-based spatial analysis.

<!-- - In the figure below, you can see a land cover map divided into a set of motifels. Each motifel consists of a large number of pixels and depicts a local pattern.-->

```{r, echo=FALSE, fig.cap="An example of a grid divided into motifels", out.width=800, fig.align='center'}
knitr::include_graphics("figs/01_motifel_grid.png")
```

---
### Motifel

It is worth to mention that a simple rule to decide on a size of a motifel doesn’t exist. The decision depends on the input data (e.g. its resolution, number of classes), type of a pattern, its variability, etc. However, a rule of thumb is to look closely at your data and keep in mind two things:

1. There should be enough pixels to create a pattern. That is why GeoPAT 2 does not allow for a mofitels smaller than 10 by 10 pixels.
2. Single motifels usually should not encapsulate many different patterns.

---
### Signature

.left-column2[
- **Motifel** is a spatial data representation preferable by humans as our pattern processing capabilities were improved in millions of years of evolution.
However, computers cannot see patterns in the same way as we do, and we need to transform the spatial pattern data into a form recognizable by machines.
Fortunately, there are many ways to do so and GeoPAT 2 offers some of them.
They are called **signatures**.
]

.right-column2[
```{r, echo=FALSE, fig.cap="LALA", out.width=500, fig.align='center'}
knitr::include_graphics("figs/02_signatures_examples0.png")
```
]

---
### Signature

```{r, echo=FALSE, fig.cap="LALA", out.width=500, fig.align='center'}
knitr::include_graphics("figs/02_signatures_examples.png")
```

- The simplest **signature** of a motifel is its composition (Cartesian product, `prod`) - a number of cells of each map category.
It is a very compact representation, although it doesn't contain information related to the configuration of categories. 
This is a role for the following **signature** - spatial co-occurrence of categories (`cooc`).
Spatial co-occurrence of categories is a $k$ by $k$ square matrix, where $k$ is a number of classes in a landscape.
Class co-occurrence matrix counts a number of pairs of classes assigned to neighboring cells.
Next, the co-occurrence matrix is transformed into a normalized co-occurrence histogram.
In this **signature**, a landscape with $k$ classes can be represented by the co-occurrence histogram of $(k^2 + k)/2$ elements.
Importantly, a $k$ number of them is related to the class composition and $(k^2 - k)/2$ is related to the class configuration.

---
### Signature

```{r, echo=FALSE, fig.cap="LALA", out.width=500, fig.align='center'}
knitr::include_graphics("figs/02_signatures_examples.png")
```

<!--Take a look at the example above and compare information depicted by the compositional and co-occurrence histograms.
The first one shows that each land cover category occupies a very similar proportion of the area.
The second one provides more information - it counts how often different categories are adjacent to each other.
These histograms also have some important properties - rotated or mirrored version of a landscape will still have the same non-spatial representation.-->

The **signatures** mentioned above are suitable for a numeric comparison between **motifels** using **similarity metrics** (more about them below).
There are three additionals **signatures** - "landscape indices" (`lind`), "selected landscape indices" (`linds`), and "Shannon entropy" (`ent`), and their role is mostly limited to describing motifels.

---
### Similarity metric

.left-column2[
- Two of the **signatures** mentioned above, `prod` and `cooc`, have a special power - they allow for comparisons between any pair of motifels. 
In a similar way, as a human can look at two images and decide if they are similar or not, GeoPAT 2 can take two motifels and compare their **signatures**. 
It also has important advantages comparing to a human perception. 
Firstly, the GeoPAT 2 results are consistent and reproducible, while human perception can be erratic and differs between individuals.
Secondly, GeoPAT 2 gives a numerical value of similarity between two motifels.
]

.right-column2[
```{r, echo=FALSE, fig.cap="LALA", out.width=500, fig.align='center'}
knitr::include_graphics("figs/03_motifel_signatures.png")
```
]

---
### Similarity metric

.left-column2[
- To calculate a similarity between them we need to have a way to measure how these histograms are alike. 
GeoPAT 2 has several **similarity metrics** that were build to compare two histograms.
<!--This numerical value depends on a selected similarity metric.-->
It includes Jensen Shannon divergence (`jsd`), Triangular (`tri`),  Wave-Hedges distance (`wh`), and Jaccard distance (`jac`).
They are explained in detail in [the GeoPAT 2 manual](https://zenodo.org/record/1291123).
]

.right-column2[
```{r, echo=FALSE, fig.cap="LALA", out.width=500, fig.align='center'}
knitr::include_graphics("figs/03_motifel_signatures.png")
```
]

---
### Similarity metric

.left-column2[
```{r, echo=FALSE, warning=FALSE}
jsd_result = structure(list(V1 = c(0, 0.114750416014047, 0.00293772511887314),
                            V2 = c(0.114750416014047, 0, 0.089399714585066),
                            V3 = c(0.00293772511887314, 0.089399714585066, 0)), 
                       row.names = c(NA, -3L), class = c("tbl_df", "tbl", "data.frame"))
knitr::kable(jsd_result, 
             digits = 3,
             row.names = c(1, 2, 3),
             col.names = c(1, 2, 3),
             caption = "Comparision of the Jensen Shannon divergence values between the example motifels (landscapes)", format = "html")
```

- I've calculated the Jensen Shannon divergence values between the three examples from the above figure.
The smaller this value is the more similar are two **motifels**.
The results are, as expected, consistent with the human perception. 
The first and third motifel are the most similar with the `jsd` value of 0.003 - both motifels have only three categories and their patterns are analogous.
The second motifel is less similar to both the first one (the `jsd` value of 0.115) and the third one (the `jsd` value of 0.089). 
It has an additional land cover category ("grassland"), different proportions of land cover categories and their configurations.
]

.right-column2[
```{r, echo=FALSE, fig.cap="LALA", out.width=500, fig.align='center'}
knitr::include_graphics("figs/03_motifel_signatures.png")
```
]

---
layout: false
class: middle, center

# Installation

---
layout: false
class: middle, center

# Datasets


---
layout: false
class: middle, center

# Search

---
### Search

- Nowadays, convenient search engines (such as [Google](https://www.google.com/) or [DuckDuckGo](https://duckduckgo.com/)) are essential tools in everyday life. 
We check the news, look for the products reviews, or find the way [how to make solar eclipse glasses](https://trends.google.com/trends/yis/2017/GLOBAL/).
Most of our searches have one thing in common though - they are based on text phrases.
Additionally, some less common search methods are possible, including [reverse image search](https://support.google.com/websearch/answer/1325808).

- Spatial data analysis also offers several distinct ways to search. 
Some only depends on [values in a vector's attribute table](http://geocompr.robinlovelace.net/attr.html#vector-attribute-subsetting) or [raster's values](http://geocompr.robinlovelace.net/attr.html#raster-subsetting). 
There are also methods that search based on spatial properties of the data, for example, how [an object relate in space to another one](http://geocompr.robinlovelace.net/spatial-operations.html#spatial-subsetting).
You can look for intersections, touches, is within, etc.
Finally, it is possible to search by distance.

---
### Search

Can you guess what are we missing in this long list?
Yes, you're (probably) right!
Finding places with similar spatial patterns is not a standard spatial operation.
However, it could be useful to solve many potential questions.
For example, you observed some ecological process and assume that it depends on a pattern of land cover.
Next, you need to find and study areas of similar land cover patterns to validate your results.
Fortunately, finding similar spatial patterns is one of the GeoPAT 2 main features.

It consists of three steps:

1. Extracting local pattern features of a query (location of interest).
2. Creating a grid of motifels.
3. Comparing a query and a grid of motifels.

---
### Search

- Spatial pattern search requires just two things - a query (location of interest) and a context (the same data of a larger area).
In this example, we use a 6 by 6 km site in Pilliga Forests in New South Wales, Australia as our location of interest.

- This area is mostly occupied by evergreen and deciduous broad-leaved forest, but also has a few smaller patches of shrublands.

.right-column2[
```{r, echo=FALSE, fig.cap="LALA", out.width=500, fig.align='center'}
knitr::include_graphics("figs/search01.png")
```
]

---
### Search - step 1

- In the first step, we need to convert this map (spatial patterns of categories) into a numerical **signature** (read [the previous blog post](/post/pattern-based-spatial-analysis-core-ideas) to learn more about **signatures**) using the `gpat_pointshis` module.
It requires a number of parameters:

- `-i` - an input map covering the whole area that we want to be searched
- `-o` - a name of the output text file containing **a signature** of the query
- `-s` - a representation of the query (a type of **signature**)
- `-x` and `-y` - x and y coordinates of the query (alternatively, a file with coordinates can be provided with `--xy_file=<file_name>`)
- `-z` - a size of the query in pixels

```{bash, eval = FALSE}
gpat_pointshis -i cci_lc2015.tif -o query_signature.txt -s cooc -x 1457570 -y -3562186 -z 20
```

- In this example, a land cover dataset with a resolution of 300 meters and covering Australia is our input map.
We selected the spatial co-occurrence of categories (`cooc`) as a type of **signature** because we are interested not only in a composition of land cover classes but also in its pattern.
The last parameters determine coordinates of a central point (`-x 1457570 -y -3562186`) and the size of a query (`-z 20`). 
In other words, the area of interest is a rectangle of 6000 by 6000 meters (20 pixels x map resolution of 300 meters) with the above coordinates in the middle.

---
### Search - step 2

.left-column2[
```{r, echo=FALSE, fig.cap="LALA", out.width=500, fig.align='center'}
knitr::include_graphics("figs/australia_ccilc.png")
```
]

.right-column2[
In the second step, we create a grid of motifels - a database of patterns for the area of Australia.

Using the `gpat_gridhis` module, we need to provide:

- `-i` - an input map covering the whole area that we want to be searched
- `-o` - a name of the output file containing signatures of each landscape in the input map (a grid of motifels)
- `-s` - a representation of the query (a type of **signature**)
- `-z` and `-f` - a size of the landscapes from which signatures will be extracted

```{bash, eval = FALSE}
gpat_gridhis -i cci_lc2015.tif -o reference.grd -s cooc -z 20 -f 20
```
]

---
### Search - step 3

- Finally, we compare pattern in our query (step 1) with every local 6 by 6 km patterns on the whole continent (step 2).
Therefore, only four parameters are required by `gpat_search`:

- `-i` - a grid of motifels
- `-o` - a final map of similarity between `-i` and `-r`
- `-r` - a text file with a numerical **signature** of our query
- `-m` - a selected [**similarity metric**](read [the previous blog post](/post/pattern-based-spatial-analysis-core-ideas) to learn more about **similarity metrics**)

```{bash, eval = FALSE}
gpat_search -i reference.grd -o similarity_output -r query_signature.txt -m jsd
```

---
### Search

.left-column2[
- The output map is a raster of similarity between our query and the reference map.

- Most of the reference map's area is very different than our query (low values of similarity indicated by dark colors).
However, there is also a visible number of places with a very similar local pattern. 
They are located in the south-west and east Australia and on Tasmania.
]

.right-column2[
```{r, echo=FALSE, fig.cap="Similarity of land cover patterns between the query and the reference map", out.width=500, fig.align='center'}
knitr::include_graphics("figs/search03.png")
```
]

---
### Search

- Finally, we can just use standard GIS methods and extract areas with the most similar land cover pattern to our query.

- They do not only have the same land cover classes, but also its composition and configuration are very similar.

```{r, echo=FALSE, fig.cap="The query and six the most similar local landscapes to it", out.width=500, fig.align='center'}
knitr::include_graphics("figs/search04.png")
```

---
### Search

```{bash, eval=FALSE}
gpat_pointshis -i cci_lc2015.tif -o query_signature.txt -s cooc -x 1457570 -y -3562186 -z 20
gpat_gridhis -i cci_lc2015.tif -o reference.grd -s cooc -z 20 -f 20
gpat_search -i reference.grd -o similarity_output -r query_signature.txt -m jsd
```

---
### Search - resources

<!--webapp-->

---
### Search - resources

<!--papers??-->

---
layout: false
class: middle, center

# Compare

---
layout: false
class: middle, center

# Segmentation

---
layout: false
class: middle, center

# Clustering

---
layout: false
class: middle, center

# Extendibility

---
layout: false
class: middle, center

# Conclusions

---
layout: false
class: inverse, middle, center

```{r, include=FALSE, eval=FALSE}
devtools::install_github("ropenscilabs/icon")
```

## Thank you

.pull-left[
## Me:

Twitter: `r icon::ii_social_twitter()` jakub_nowosad

Email: nowosad.jakub@gmail.com
]

.pull-right[
## Resources:

https://nowosad.github.io

http://sil.uc.edu
]

.footnote[
**Slides:** https://github.com/Nowosad/geostat18
]
